<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Meute - an unhosted messages/contacts/search app</title>
    <style>
      body { font:15px sans-serif; line-height:1.4em; color:#222 }
      nav {float:left; margin:3em}
      nav div { border-style:solid; border-radius:1em; margin: 1em; padding: 1em}
      nav div table tr td img { width:4em; height:4em; border-radius:1em }
      article table tr td img { width:3em; height:3em; border-radius:1em }
      article {float:left; margin-top:4em; padding:1em; border-style:solid; border-radius:1em}
    </style>
  </head>
  <body>
    <div>
      <table id="tableBefore"></table>
    </div>
    <div>
      Was: <input placeholder="Umschreibung" id="description" />
      Durch: <input placeholder="mir" id="by" />
      Fuer: <input placeholder="beide" id="for" />
      Wie viel?: <input placeholder="... EUR" id="amount" />
      <input value="Save" type="submit" onclick="save();" />
    </div>
    <table id="tableAfter"></table>
    <input type="submit" value="export" onclick="exportIOUs();" />
    <textarea id="import"></textarea>
    <input type="submit" value="import" onclick="importIOUs();" />
  </body>
  <script src="remotestorage-0.8.4.js"></script>
  <script src="remotestorage-money.js"></script>
  <script>
    remoteStorage.displayWidget();
    remoteStorage.claimAccess('money', 'rw');
    function createUuid() {
      return Math.random().toString();
    }
    function save() {
      remoteStorage.money.getIOUs('Hannah').then(function(IOUs) {
        IOUs.push({
          id: createUuid(),
          replaces: (editing == -1 ? undefined : IOUs[editing].id),
          description: document.getElementById('description').value,
          by: document.getElementById('by').value,
          for: document.getElementById('for').value,
          amount: parseInt(document.getElementById('amount').value)});
         remoteStorage.money.setIOUs('Hannah', IOUs);
        render();
      });
    }
    function loadExampleIOUs() {
      remoteStorage.money.setIOUs('Hannah', [{
        id: createUuid(),
        description: 'Fluege Antalya',
        by: 'you', for: 'both',
        amount: 145
      }, {
        id: createUuid(),
        description: 'Kappe',
        by: 'you', for: 'both',
        amount: 150
      }, {
        id: createUuid(),
        description: 'Ueberweisung',
        by: 'you', for: 'me',
        amount: 300
      }, {
        id: createUuid(),
        description: 'Fluege India',
        by: 'me', for: 'both',
        amount: 596
      }, {
        id: createUuid(),
        description: 'Naehmaschinenpedal',
        by: 'you', for: 'both',
        amount: 40
      }, {
        id: createUuid(),
        description: 'Routers',
        by: 'me', for: 'both',
        amount: 40 
      }, {
        id: createUuid(),
        description: 'Noch ein Router',
        by: 'me', for: 'both',
        amount: 29.95 
      }, {
        id: createUuid(),
        description: 'Skype Guthaben',
        by: 'me', for: 'you',
        amount: 28 
      }, {
        id: createUuid(),
        description: 'Impfung',
        by: 'you', for:'me',
        amount: 55
      }]);
    }
    function makeTable(IOUs, offset, settle) {
      var str = '';
      if(offset==0) {
        str = '<tr>'
          +'<td>Was?</td>'
          +'<td>Wie viel?</td>'
          +'<td>EUR?</td>'
          +'<td>Durch</td>' 
          +'<td>Fuer</td>'
          +'<td>Ich habe bezahlt</td>'
          +'<td>Du hast bezahlt</td>'
          +'</tr>';
      }
      var i, balance= { me: 0, you: 0 }, effect;
      for(i=0;i<IOUs.length;i++) {
        effect = IOUs[i].amount;
        if(IOUs[i].currency) {
          effect *= factor[IOUs[i].currency];
        }
        balance[IOUs[i].by] += effect;
        if(IOUs[i].for != 'both') {
          balance[IOUs[i].for] -= effect;
        }
        
        str += '<tr><td>'+IOUs[i].description
          +'</td><td>'+IOUs[i].amount
          +'</td><td>'+(IOUs[i].currency ? IOUs[i].currency : '')
          +'</td><td>'+IOUs[i].by
          +'</td><td>'+IOUs[i].for
          +'</td><td>'+balance.me
          +'</td><td>'+balance.you
          +'</td><td><input type="submit" value="Edit" onclick="edit('+offset+i+');" />'
          +'</td></tr>';
        }
        if(settle) {
          if(balance.me > balance.you) {
            settle = -balance.you;
          } else {
            settle = -balance.me;
          }
          balance.me += settle;
          balance.you += settle;
          str += '<tr><td>Settle:</td><td>'+settle+'</td>'
            +'<td></td><td>both</td><td>settle</td><td>'+balance.me+'</td><td>'
            +balance.you+'</td></tr>';
        }
        return str+'</table>';
      }
      var editing = -1;
      //loadExampleIOUs();
      function render() {
        remoteStorage.money.getIOUs('Hannah').then(function(IOUs) {
          console.log('render read in IOUs', IOUs);
          var IOUsBefore, IOUsAfter;
          if(editing == -1) {
            IOUsBefore = IOUs;
            IOUsAfter = [];
          } else {
            IOUsBefore = IOUs.slice(0, editing);
            IOUsAfter = IOUs.slice(editing+1, IOUs.length);
          }
          document.getElementById('tableBefore').innerHTML=makeTable(IOUsBefore, 0, (editing==-1));
          document.getElementById('tableAfter').innerHTML=makeTable(IOUsAfter, editing+1, (editing!=-1));
        });
      }
      function edit(i) {
        remoteStorage.money.getIOUs('Hannah').then(function(IOUs) {
          console.log('edit read in IOUs', IOUs);
          var editing = i;
          document.getElementById('description').value = IOUs[i].description;
          document.getElementById('amount').value = IOUs[i].amount;
          document.getElementById('by').value = IOUs[i].by;
          document.getElementById('for').value = IOUs[i].for;
          render();
        });
      }
      function exportIOUs() {
        remoteStorage.money.getIOUs('Hannah').then(function(IOUs) {
          document.body.innerHTML = JSON.stringify(IOUs);
        });
      }
      function importIOUs() {
        try {
          IOUs = JSON.parse(document.getElementById('import').value);
        } catch(e) {
          console.log('not valid JSON');
          return;
        }
        remoteStorage.money.setIOUs('Hannah', IOUs);
      }
    render();
  </script>
</html>
todo:
- debug add and edit behavior further
